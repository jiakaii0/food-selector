<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mega Mall Food Decider v5.2</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --text-main: #2d3436;
            --accent: #e84393;
            --wheel-border: #ffffff;
            --price-low: #00b894;
            --price-mid: #0984e3;
            --price-high: #6c5ce7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 15px;
        }

        /* HEADER */
        header { text-align: center; margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.8rem; color: #2d3436; font-weight: 900; letter-spacing: -1px; }
        .subtitle { font-size: 0.85rem; color: #636e72; margin-top: 5px; font-weight: 500; }

        /* LAYOUT */
        .app-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            width: 100%;
            max-width: 1100px;
            justify-content: center;
            align-items: flex-start;
        }

        /* CONTROLS (LEFT) */
        .control-panel {
            flex: 1;
            min-width: 320px;
            background: var(--card-bg);
            padding: 25px;
            border-radius: 24px;
            box-shadow: 0 12px 30px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.03);
        }

        .input-group { margin-bottom: 15px; }
        .input-group label {
            display: block; font-size: 0.7rem; font-weight: 800; 
            color: #b2bec3; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }

        select, input {
            width: 100%; padding: 14px; border: 2px solid #edf2f7;
            border-radius: 12px; font-size: 0.95rem; background: #f8fafc;
            color: #2d3436; font-weight: 600; transition: 0.2s; appearance: none;
        }
        select:focus, input:focus { border-color: var(--accent); outline: none; background: #fff; }

        .filter-row { display: flex; gap: 10px; }

        .badge-row {
            display: flex; justify-content: space-between; 
            align-items: center; margin-top: 15px; font-size: 0.85rem; color: #636e72; font-weight: 600;
        }
        #countBadge { background: #dfe6e9; padding: 5px 12px; border-radius: 20px; color: #2d3436; }
        .reset-link { color: #e17055; cursor: pointer; text-decoration: underline; font-size: 0.8rem; margin-left: 10px; display: none; }

        .spin-btn {
            width: 100%; background: #2d3436; color: white; border: none;
            padding: 18px; font-size: 1.1rem; font-weight: 800; border-radius: 16px;
            cursor: pointer; margin-top: 20px; transition: transform 0.1s, box-shadow 0.2s;
            box-shadow: 0 10px 20px rgba(45, 52, 54, 0.2);
        }
        .spin-btn:active { transform: scale(0.98); }
        .spin-btn:disabled { background: #b2bec3; cursor: not-allowed; box-shadow: none; }

        /* WHEEL (RIGHT) */
        .wheel-wrapper {
            position: relative;
            width: 360px; height: 360px;
            flex-shrink: 0;
        }

        .wheel-border {
            width: 100%; height: 100%; border-radius: 50%;
            border: 10px solid var(--wheel-border);
            box-shadow: 0 20px 60px rgba(0,0,0,0.1);
            overflow: hidden; position: relative; background: white;
        }

        canvas { width: 100%; height: 100%; display: block; }

        .marker {
            position: absolute; top: -15px; left: 50%; transform: translateX(-50%);
            width: 30px; height: 40px; background: var(--accent);
            clip-path: polygon(50% 100%, 0% 0%, 100% 0%);
            z-index: 10; filter: drop-shadow(0 4px 2px rgba(0,0,0,0.2));
        }

        .center-hub {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 60px; height: 60px; background: white; border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex;
            align-items: center; justify-content: center; font-size: 1.8rem; z-index: 5;
        }

        /* MODAL */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); backdrop-filter: blur(5px);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        .result-card {
            background: white; width: 90%; max-width: 380px; padding: 30px;
            border-radius: 30px; text-align: center; transform: scale(0.8);
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }
        .modal-overlay.active .result-card { transform: scale(1); }

        .res-icon { font-size: 3.5rem; margin-bottom: 15px; display: block; }
        .res-title { font-size: 1.6rem; font-weight: 800; margin: 10px 0 5px 0; line-height: 1.2; color: #2d3436; }
        .res-meta { color: #636e72; margin-bottom: 20px; font-size: 0.95rem; font-weight: 500; }
        
        .tags { display: flex; justify-content: center; gap: 8px; flex-wrap: wrap; margin-bottom: 25px; }
        .tag { padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;}
        
        /* Tag Colors */
        .tag.halal { background: #d4edda; color: #155724; }
        .tag.nonhalal { background: #f8d7da; color: #721c24; }
        .tag.price-low { background: #ddfbf5; color: #00b894; }
        .tag.price-mid { background: #dff9fb; color: #0984e3; }
        .tag.price-high { background: #a29bfe; color: white; }
        
        .btn-group { display: flex; gap: 10px; flex-direction: column; }
        
        .btn-map {
            background: #4285F4; color: white; text-decoration: none;
            padding: 14px 0; border-radius: 50px; font-weight: 600;
            display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s;
            box-shadow: 0 4px 15px rgba(66, 133, 244, 0.3); width: 100%;
        }
        .btn-map:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(66, 133, 244, 0.4); }
        
        .close-btn { 
            width: 100%; padding: 14px 0; background: #edf2f7; border: none; 
            color: #2d3436; cursor: pointer; font-weight: 700; font-size: 0.95rem; 
            border-radius: 50px; transition: 0.2s;
        }
        .close-btn:hover { background: #dfe6e9; }

        @media (max-width: 700px) {
            .wheel-wrapper { width: 300px; height: 300px; }
            .app-container { gap: 20px; }
        }
    </style>
</head>
<body>

    <header>
        <h1>üç± Food Decider</h1>
        <div class="subtitle">Mid Valley & The Gardens ‚Ä¢ 300+ Options</div>
    </header>

    <div class="app-container">
        <!-- Controls -->
        <div class="control-panel">
            <div class="input-group">
                <label>Search Keyword</label>
                <input type="text" id="searchInput" placeholder="e.g. Ramen, Burger, Coffee...">
            </div>

            <div class="filter-row">
                <div class="input-group" style="flex:1">
                    <label>Cuisine</label>
                    <select id="catFilter">
                        <option value="all">All Cuisines</option>
                        <option value="local">üá≤üáæ Local</option>
                        <option value="japanese">üáØüáµ Japanese</option>
                        <option value="chinese">üá®üá≥ Chinese</option>
                        <option value="western">üçî Western</option>
                        <option value="beverage">‚òï Coffee/Dessert</option>
                        <option value="snack">ü•® Snacks</option>
                    </select>
                </div>
                <div class="input-group" style="flex:1">
                    <label>Dietary</label>
                    <select id="dietFilter">
                        <option value="all">All</option>
                        <option value="halal">Halal / Pork-Free</option>
                        <option value="nonhalal">Non-Halal</option>
                    </select>
                </div>
            </div>

            <div class="filter-row">
                <div class="input-group" style="flex:1">
                    <label>Price Range</label>
                    <select id="priceFilter">
                        <option value="all">All Prices</option>
                        <option value="low">$ (Budget &lt;RM25)</option>
                        <option value="mid">$$ (Casual RM25-60)</option>
                        <option value="high">$$$ (Premium &gt;RM60)</option>
                    </select>
                </div>
                <div class="input-group" style="flex:1">
                    <label>Location</label>
                    <select id="mallFilter">
                        <option value="all">Both Malls</option>
                        <option value="MV">Mid Valley</option>
                        <option value="TG">The Gardens</option>
                    </select>
                </div>
            </div>

            <div class="badge-row">
                <div>
                    <span id="countBadge">Loading...</span>
                    <span class="reset-link" id="resetBtn" onclick="resetExclusions()">Reset Ignore List</span>
                </div>
                <span>v5.2</span>
            </div>

            <button class="spin-btn" id="spinBtn" onclick="spinWheel()">Find Food!</button>
        </div>

        <!-- Wheel -->
        <div class="wheel-wrapper">
            <div class="marker"></div>
            <div class="wheel-border">
                <canvas id="wheelCanvas" width="800" height="800"></canvas>
            </div>
            <div class="center-hub">ü§§</div>
        </div>
    </div>

    <!-- Result Modal -->
    <div class="modal-overlay" id="resultModal">
        <div class="result-card">
            <span class="res-icon">üéâ</span>
            <div class="res-title" id="resName">Restaurant Name</div>
            <div class="res-meta" id="resLoc">Location Info</div>
            <div class="tags" id="resTags"></div>
            
            <div class="btn-group">
                <a href="#" id="mapsLink" target="_blank" class="btn-map">
                    <span>Open Google Maps</span>
                </a>
                <button class="close-btn" onclick="closeModalAndExclude()">Spin Again (Remove This)</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        // --- DATASET V5.2: ADDED PRICE CATEGORY ---
        // p: '$' (Low), '$$' (Mid), '$$$' (High)
        // h: 'H' (Halal/PorkFree), 'NH' (NonHalal)
        // m: 'MV' (Mid Valley), 'TG' (The Gardens)
        
        const masterData = [
            // FAST FOOD / WESTERN ($ / $$)
            {n:"4Fingers", c:"western", h:"H", m:"MV", p:"$"},
            {n:"A&W", c:"western", h:"H", m:"MV", p:"$"},
            {n:"Burger King", c:"western", h:"H", m:"MV", p:"$"},
            {n:"Carl's Jr", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"KFC", c:"western", h:"H", m:"MV", p:"$"},
            {n:"McDonald's", c:"western", h:"H", m:"MV", p:"$"},
            {n:"Nando's", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"Subway", c:"western", h:"H", m:"MV", p:"$"},
            {n:"Texas Chicken", c:"western", h:"H", m:"MV", p:"$"},
            {n:"TGI Fridays", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"Chili's", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"Pizza Hut", c:"western", h:"H", m:"MV", p:"$"},
            {n:"Rightside", c:"western", h:"H", m:"MV", p:"$"},
            {n:"The Barn", c:"western", h:"NH", m:"MV", p:"$$"},
            {n:"Antipodean", c:"western", h:"NH", m:"MV", p:"$$"},
            {n:"Red Kettle", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Alexis", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Spag & Ju's", c:"western", h:"H", m:"MV", p:"$"},
            {n:"Manhattan Fish", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"Snitch", c:"western", h:"NH", m:"TG", p:"$$"},
            {n:"myBurgerLab", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"KGB Burgers", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Stuff'd", c:"western", h:"H", m:"MV", p:"$"},
            {n:"DOME Cafe", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Coliseum Cafe", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"Padi House", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"Tapestry", c:"western", h:"H", m:"MV", p:"$$"},
            {n:"The Fish Bowl", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Ben's", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Fat Daddy", c:"western", h:"H", m:"MV", p:"$"},
            {n:"MARCO", c:"western", h:"H", m:"TG", p:"$$"},
            {n:"Shucked Oyster", c:"western", h:"NH", m:"TG", p:"$$$"},
            {n:"LingLing LongLong", c:"western", h:"NH", m:"TG", p:"$$"},
            {n:"MST Golf Arena", c:"western", h:"NH", m:"TG", p:"$$"},
            {n:"Kubis & Kale", c:"western", h:"H", m:"MV", p:"$$"},

            // JAPANESE / KOREAN
            {n:"Sukiya", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Sushi King", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Sushi Jiro", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Sushi Zanmai", c:"japanese", h:"H", m:"MV", p:"$$"},
            {n:"Genki Sushi", c:"japanese", h:"H", m:"TG", p:"$$"},
            {n:"Rakuzen", c:"japanese", h:"H", m:"TG", p:"$$"},
            {n:"Yuzu Japanese", c:"japanese", h:"H", m:"TG", p:"$$$"},
            {n:"Kiku-Zakura", c:"japanese", h:"H", m:"MV", p:"$$"},
            {n:"Shinmapo BBQ", c:"japanese", h:"NH", m:"TG", p:"$$$"},
            {n:"Palsaik BBQ", c:"japanese", h:"NH", m:"MV", p:"$$"},
            {n:"KyoChon 1991", c:"japanese", h:"H", m:"MV", p:"$$"},
            {n:"DubuYo", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"MyeongDong", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Ra-Men Bankara", c:"japanese", h:"NH", m:"MV", p:"$$"},
            {n:"Ippudo Ramen", c:"japanese", h:"NH", m:"TG", p:"$$"},
            {n:"Wagyu More", c:"japanese", h:"NH", m:"TG", p:"$$$"},
            {n:"Tanba BBQ", c:"japanese", h:"NH", m:"TG", p:"$$$"},
            {n:"BUSHIDO", c:"japanese", h:"NH", m:"MV", p:"$$"},
            {n:"Empire Sushi", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Hotpot Kitchen", c:"japanese", h:"NH", m:"MV", p:"$$"},
            {n:"Mala Mini Hotpot", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Yayoi", c:"japanese", h:"NH", m:"TG", p:"$$"},
            {n:"YewYewKL", c:"japanese", h:"H", m:"TG", p:"$"},
            {n:"BBQ Town", c:"japanese", h:"H", m:"MV", p:"$$"},
            {n:"Kamakura", c:"japanese", h:"H", m:"TG", p:"$$"},
            {n:"Tamago-EN", c:"japanese", h:"NH", m:"TG", p:"$$"},
            {n:"Shojikiya", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"SUSHIHAN", c:"japanese", h:"H", m:"MV", p:"$$"},
            {n:"Hojo", c:"japanese", h:"H", m:"TG", p:"$$"},
            {n:"ROCKU Yakiniku", c:"japanese", h:"NH", m:"TG", p:"$$"},
            {n:"eMart24", c:"japanese", h:"H", m:"MV", p:"$"},
            {n:"Ko Hyang", c:"japanese", h:"H", m:"TG", p:"$$"},

            // CHINESE / DIM SUM
            {n:"Din Tai Fung", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"Dragon-i", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"Canton-i", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"The Han Room", c:"chinese", h:"NH", m:"TG", p:"$$$"},
            {n:"Paradise Dynasty", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"Putien", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"Xiao Long Kan", c:"chinese", h:"NH", m:"MV", p:"$$$"},
            {n:"Go Noodle House", c:"chinese", h:"NH", m:"MV", p:"$$"},
            {n:"Zok Noodle", c:"chinese", h:"NH", m:"MV", p:"$"},
            {n:"Sin Man Kee", c:"chinese", h:"NH", m:"MV", p:"$"},
            {n:"Mak's Chee", c:"chinese", h:"NH", m:"MV", p:"$$"},
            {n:"Koong Woh Tong", c:"chinese", h:"H", m:"MV", p:"$"},
            {n:"Purple Cane", c:"chinese", h:"H", m:"TG", p:"$$"},
            {n:"Souper Tang", c:"chinese", h:"H", m:"MV", p:"$$"},
            {n:"ManJoe", c:"chinese", h:"H", m:"TG", p:"$"},
            {n:"Jipinhe Scones", c:"chinese", h:"H", m:"MV", p:"$"},
            {n:"Sek Tong", c:"chinese", h:"NH", m:"MV", p:"$"},
            {n:"Omega Pork Noodle", c:"chinese", h:"NH", m:"MV", p:"$"},
            {n:"House of Pok", c:"chinese", h:"NH", m:"MV", p:"$$"},
            {n:"Lucky Mala", c:"chinese", h:"NH", m:"MV", p:"$"},
            {n:"Pulau Ketam YTF", c:"chinese", h:"NH", m:"MV", p:"$"},
            {n:"Fong Lye", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"Beauty In Pot", c:"chinese", h:"NH", m:"TG", p:"$$$"},
            {n:"Claypot House", c:"chinese", h:"NH", m:"MV", p:"$$"},
            {n:"Village Roast Duck", c:"chinese", h:"NH", m:"TG", p:"$$"},
            {n:"YU By Oriental", c:"chinese", h:"NH", m:"TG", p:"$$$"},
            {n:"Grand Taipei", c:"chinese", h:"NH", m:"MV", p:"$$"},
            {n:"Peng Chu", c:"chinese", h:"NH", m:"MV", p:"$$"},
            {n:"Travelling Duck", c:"chinese", h:"NH", m:"TG", p:"$$"},

            // LOCAL / THAI
            {n:"Ah Cheng Laksa", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Ali, Muthu & Ah Hock", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Bungkus Kaw Kaw", c:"local", h:"H", m:"TG", p:"$"},
            {n:"Madam Kwan's", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"Little Penang", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"Sepiring", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"NALE Nasi Lemak", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"Nasi Lemak Shop", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Oriental Kopi", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Original Penang Kayu", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"PappaRich", c:"local", h:"H", m:"TG", p:"$$"},
            {n:"Sedap Sedap", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Chicken Rice Shop", c:"local", h:"H", m:"MV", p:"$"},
            {n:"UPEH", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"MyIpoh", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Nanyang Cafe", c:"local", h:"NH", m:"MV", p:"$$"},
            {n:"Kim Gary", c:"local", h:"NH", m:"MV", p:"$$"},
            {n:"Lim Fried Chicken", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Penang Flavours", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Absolute Thai", c:"local", h:"H", m:"TG", p:"$$"},
            {n:"Amarin Thai", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"Mr Tuk Tuk", c:"local", h:"H", m:"TG", p:"$$"},
            {n:"Boat Noodle", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Pho Vietz", c:"local", h:"NH", m:"MV", p:"$$"},
            {n:"An Viet", c:"local", h:"NH", m:"TG", p:"$$"},
            {n:"Childhood", c:"local", h:"H", m:"MV", p:"$"},
            {n:"Rich Kopitiam", c:"local", h:"H", m:"MV", p:"$"},
            {n:"BananaBro", c:"local", h:"H", m:"MV", p:"$$"},
            {n:"Nyonya Colors", c:"local", h:"H", m:"TG", p:"$"},
            {n:"PopCorn Food Hall", c:"local", h:"H", m:"MV", p:"$"},

            // BEVERAGE / DESSERT
            {n:"Starbucks Reserve", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"Coffee Bean", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"ZUS Coffee", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"GIGI Coffee", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"HWC Coffee", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Kenangan Coffee", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"San Francisco", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"Tealive Plus", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Gong Cha", c:"beverage", h:"H", m:"TG", p:"$"},
            {n:"KOI The", c:"beverage", h:"H", m:"TG", p:"$"},
            {n:"Chagee", c:"beverage", h:"H", m:"TG", p:"$"},
            {n:"Boost Juice", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Llaollao", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Baskin Robbins", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Haagen Dazs", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Inside Scoop", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"Secret Recipe", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Paris Baguette", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Komugi", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Lavender", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"BreadStory", c:"beverage", h:"H", m:"TG", p:"$"},
            {n:"Christine's Bakery", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Halla Holla", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Yole", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Soyya", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Bean Factory", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Cha Tra Mue", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Beutea", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Machi Machi", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"HEYTEA", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Chateraise", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Venchi", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"Nadeje", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Snowflake", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Creme de la Creme", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"Udders Ice Cream", c:"beverage", h:"NH", m:"TG", p:"$$"},
            {n:"Juice Works", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"HeLo Moo!", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Shantea", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Squeezby", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Just Good Coffee", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Eight Ounce", c:"beverage", h:"H", m:"TG", p:"$$"},
            {n:"Nespresso", c:"beverage", h:"H", m:"TG", p:"$"},
            {n:"TWG Tea", c:"beverage", h:"H", m:"TG", p:"$$$"},
            {n:"Yomie's Yogurt", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Sugirl Desserts", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Vanilla Mille Crepe", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Lapisan Patisserie", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"POBBYICE", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Yogurt Factory", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"Nononsense Coffee", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"B.O.D", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"dipndip", c:"beverage", h:"H", m:"MV", p:"$$"},
            {n:"Lung Ngen Coffee", c:"beverage", h:"H", m:"MV", p:"$"},
            {n:"ShuYi Grass Jelly", c:"beverage", h:"H", m:"MV", p:"$"},
            
            // SNACKS
            {n:"Auntie Anne's", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Famous Amos", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Hot & Roll", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Shihlin Snacks", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Eggette Lab", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Garrett Popcorn", c:"snack", h:"H", m:"MV", p:"$$"},
            {n:"Ipoh Kacang Putih", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Mahnaz Food", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Oloiya", c:"snack", h:"NH", m:"TG", p:"$$"},
            {n:"Bee Cheng Hiang", c:"snack", h:"NH", m:"MV", p:"$$"},
            {n:"I Love Yoo!", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Dunkin'", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Cinnabon", c:"snack", h:"H", m:"TG", p:"$"},
            {n:"Beard Papa's", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Ben's Cookies", c:"snack", h:"H", m:"TG", p:"$"},
            {n:"Barcook", c:"snack", h:"H", m:"TG", p:"$"},
            {n:"Flaaah Bakery", c:"snack", h:"H", m:"TG", p:"$"},
            {n:"Yin's Sourdough", c:"snack", h:"H", m:"TG", p:"$$"},
            {n:"Founders Bakery", c:"snack", h:"H", m:"MV", p:"$$"},
            {n:"Finest Bake", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Good Chen", c:"snack", h:"H", m:"MV", p:"$$"},
            {n:"Jungle House", c:"snack", h:"H", m:"MV", p:"$$"},
            {n:"Herbal Farmer", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Taimal Herbs", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"MBG FruitShop", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Yong Sheng", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Signature Market", c:"snack", h:"H", m:"MV", p:"$$"},
            {n:"MiX Store", c:"snack", h:"NH", m:"MV", p:"$"},
            {n:"Beryl's", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Royce Chocolate", c:"snack", h:"H", m:"TG", p:"$$"},
            {n:"Laderach", c:"snack", h:"H", m:"TG", p:"$$"},
            {n:"Homi Curry Puff", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Chonky Cookies", c:"snack", h:"H", m:"TG", p:"$"},
            {n:"APOLLO", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Happy Potato", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Sisters Popiah", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Krispy Kreme", c:"snack", h:"H", m:"MV", p:"$"},
            {n:"Delectable Treats", c:"snack", h:"H", m:"TG", p:"$$"}
        ];

        let activeData = [];
        let excludedItems = []; // Stores names of items to exclude
        let rotation = 0;
        let isSpinning = false;
        let currentWinnerName = ""; // To store current spin result
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const colors = ['#a29bfe', '#ff7675', '#55efc4', '#74b9ff', '#ffeaa7', '#fab1a0'];

        function init() {
            filterData();
            // Event Listeners
            ['searchInput', 'catFilter', 'dietFilter', 'mallFilter', 'priceFilter'].forEach(id => {
                document.getElementById(id).addEventListener('input', filterData);
            });
            window.addEventListener('resize', () => drawWheel());
        }

        function filterData() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const cat = document.getElementById('catFilter').value;
            const diet = document.getElementById('dietFilter').value;
            const mall = document.getElementById('mallFilter').value;
            const price = document.getElementById('priceFilter').value;

            activeData = masterData.filter(item => {
                // 1. Check Exclusion List
                if (excludedItems.includes(item.n)) return false;

                // 2. Search
                if (search && !item.n.toLowerCase().includes(search)) return false;
                
                // 3. Category
                if (cat !== 'all' && item.c !== cat) return false;
                
                // 4. Mall
                if (mall !== 'all' && item.m !== mall) return false;
                
                // 5. Price
                if (price === 'low' && item.p !== '$') return false;
                if (price === 'mid' && item.p !== '$$') return false;
                if (price === 'high' && item.p !== '$$$') return false;
                
                // 6. Diet
                if (diet === 'halal') {
                    if (item.h === 'NH') return false;
                }
                if (diet === 'nonhalal') {
                    if (item.h !== 'NH') return false;
                }
                
                return true;
            });

            updateUI();
        }

        function updateUI() {
            const count = activeData.length;
            const badge = document.getElementById('countBadge');
            const btn = document.getElementById('spinBtn');
            const resetBtn = document.getElementById('resetBtn');

            // Update Badge Logic
            if (excludedItems.length > 0) {
                badge.innerText = `${count} Options (${excludedItems.length} Hidden)`;
                resetBtn.style.display = "inline";
            } else {
                badge.innerText = `${count} Options`;
                resetBtn.style.display = "none";
            }
            
            // Update Button Logic
            if (count === 0) {
                btn.disabled = true;
                btn.innerText = excludedItems.length > 0 ? "All Ignored / No Match" : "No Matches";
                btn.style.background = "#b2bec3";
                drawWheel(true);
            } else {
                btn.disabled = false;
                btn.innerText = `Spin (${count})`;
                btn.style.background = "#2d3436";
                drawWheel();
            }
        }

        function resetExclusions() {
            excludedItems = [];
            filterData();
        }

        function drawWheel(isEmpty = false) {
            const num = isEmpty ? 1 : activeData.length;
            const arc = (2 * Math.PI) / num;
            const r = canvas.width / 2;

            ctx.clearRect(0,0,800,800);
            ctx.save();
            ctx.translate(r, r);

            for (let i = 0; i < num; i++) {
                const angle = i * arc;
                ctx.beginPath();
                ctx.moveTo(0,0);
                ctx.arc(0,0, r, angle, angle + arc);
                ctx.fillStyle = isEmpty ? '#dfe6e9' : colors[i % colors.length];
                ctx.fill();
                ctx.stroke();

                // Text Labels (Only if not too crowded)
                if (!isEmpty && num <= 60) {
                    ctx.save();
                    ctx.rotate(angle + arc/2);
                    ctx.textAlign = "right";
                    ctx.fillStyle = "#2d3436";
                    ctx.font = "bold 14px Inter";
                    let text = activeData[i].n;
                    if (text.length > 18) text = text.substring(0,16) + "..";
                    ctx.fillText(text, r - 30, 5);
                    ctx.restore();
                }
            }
            ctx.restore();
        }

        function spinWheel() {
            if (isSpinning || activeData.length === 0) return;
            isSpinning = true;
            document.getElementById('spinBtn').disabled = true;

            const minSpins = 5;
            const extraDeg = Math.random() * 360;
            const totalDeg = (minSpins * 360) + extraDeg;
            
            rotation += totalDeg;
            
            canvas.style.transition = "transform 4s cubic-bezier(0.25, 0.1, 0.25, 1)";
            canvas.style.transform = `rotate(-${rotation}deg)`;

            setTimeout(() => {
                isSpinning = false;
                document.getElementById('spinBtn').disabled = false;
                showResult(rotation);
            }, 4000);
        }

        function showResult(deg) {
            const sliceDeg = 360 / activeData.length;
            const normalized = deg % 360;
            const index = Math.floor((360 - (normalized % 360)) / sliceDeg) % activeData.length;

            const winner = activeData[index];
            currentWinnerName = winner.n; // Save for removal
            
            // Populate Modal
            document.getElementById('resName').innerText = winner.n;
            
            let mallName = winner.m === 'MV' ? 'Mid Valley Megamall' : 'The Gardens Mall';
            document.getElementById('resLoc').innerText = mallName;

            // Tags
            const tagBox = document.getElementById('resTags');
            tagBox.innerHTML = '';

            // Price Tag
            const tP = document.createElement('span');
            tP.className = 'tag';
            if (winner.p === '$') { tP.classList.add('price-low'); tP.innerText = "$ Budget"; }
            else if (winner.p === '$$') { tP.classList.add('price-mid'); tP.innerText = "$$ Casual"; }
            else { tP.classList.add('price-high'); tP.innerText = "$$$ Premium"; }
            tagBox.appendChild(tP);

            // Diet Tag
            const t1 = document.createElement('span');
            t1.className = 'tag';
            if(winner.h === 'H') {
                t1.classList.add('halal');
                t1.innerText = "Halal / Pork-Free";
            } else {
                t1.classList.add('nonhalal');
                t1.innerText = "Non-Halal";
            }
            tagBox.appendChild(t1);

            // Cuisine Tag
            const t2 = document.createElement('span');
            t2.className = 'tag';
            if(winner.c === 'japanese') { t2.classList.add('cat-jp'); t2.innerText = "Japanese"; }
            else if(winner.c === 'western') { t2.classList.add('cat-wes'); t2.innerText = "Western"; }
            else if(winner.c === 'local') { t2.classList.add('cat-loc'); t2.innerText = "Local"; }
            else if(winner.c === 'chinese') { t2.classList.add('cat-jp'); t2.innerText = "Chinese"; }
            else { t2.style.background='#dfe6e9'; t2.innerText = winner.c.toUpperCase(); }
            tagBox.appendChild(t2);

            // Map Link
            const q = encodeURIComponent(`${winner.n} ${mallName} Kuala Lumpur`);
            document.getElementById('mapsLink').href = `https://www.google.com/maps/search/?api=1&query=${q}`;

            // Show
            document.getElementById('resultModal').classList.add('active');
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
        }

        function closeModalAndExclude() {
            // Add current winner to excluded list
            if(currentWinnerName) {
                excludedItems.push(currentWinnerName);
            }
            
            document.getElementById('resultModal').classList.remove('active');
            
            // Re-run filter to update wheel without the winner
            filterData();
        }

        init();
    </script>
</body>
</html>
